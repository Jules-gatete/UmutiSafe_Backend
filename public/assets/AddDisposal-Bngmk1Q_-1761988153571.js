import{u as L,r as l,j as e,K as M,Q as N,J as $,G as q}from"./vendor_react-Dd6aiuOH-1761988153571.js";import{I as k}from"./Input-BWxF2S0i-1761988153571.js";import{S as w}from"./Select-AVtcNLMy-1761988153571.js";import{m as u,d as S}from"./index-BNm4ZFjM-1761988153571.js";import{S as U}from"./SearchBar-CyxZkODN-1761988153571.js";import"./vendor_misc-i1ZNofER-1761988153571.js";import"./vendor_axios-ngrFHoWO-1761988153571.js";function Y(){const p=L(),[n,b]=l.useState({generic_name:"",brand_name:"",dosage_form:"",packaging_type:""}),[o,C]=l.useState(null),[f,P]=l.useState(null),[a,m]=l.useState(null),[g,c]=l.useState(!1),[v,t]=l.useState(null),[_,x]=l.useState([]),[y,I]=l.useState(!1),[j,F]=l.useState(!1),D=[{value:"Tablet",label:"Tablet"},{value:"Capsule",label:"Capsule"},{value:"Syrup",label:"Syrup"},{value:"Injection",label:"Injection"},{value:"Cream",label:"Cream"},{value:"Inhaler",label:"Inhaler"}],R=[{value:"Blister Pack",label:"Blister Pack"},{value:"Bottle",label:"Bottle"},{value:"Tube",label:"Tube"},{value:"Vial",label:"Vial"},{value:"Box",label:"Box"}],h=async r=>{const{name:s,value:i}=r.target;if(b({...n,[s]:i}),s==="generic_name"&&i.length>=2)try{const d=await u.search(i);d.success&&x(d.data)}catch(d){console.error("Search error:",d)}else s==="generic_name"&&x([])},A=r=>{b({...n,generic_name:r.genericName,brand_name:r.brandName}),x([])},G=r=>{const s=r.target.files[0];if(s){C(s);const i=new FileReader;i.onloadend=()=>{P(i.result)},i.readAsDataURL(s)}},T=async r=>{if(r.preventDefault(),!n.generic_name){alert("Please enter at least the generic medicine name.");return}c(!0),t(null);try{const s=await u.predictFromText({genericName:n.generic_name,brandName:n.brand_name,dosageForm:n.dosage_form,packagingType:n.packaging_type});if(s&&s.success)m(s.data);else{const i=s?.error?.message||s?.error||"Prediction failed. Please try again.";t(i),m(null)}}catch(s){console.error("Prediction error:",s),t(s?.message||"Failed to predict. Please try again.")}finally{c(!1)}},B=async()=>{if(!o){alert("Please upload an image first.");return}c(!0),t(null);try{const r=await u.predictFromImage(o);if(r.success)b({generic_name:r.data.ocr_text?.medicine_name||"",brand_name:r.data.ocr_text?.brand_name||"",dosage_form:"",packaging_type:""}),m(r.data);else{const s=r?.error?.message||r?.error||"Image prediction failed. Please try again.";t(s),m(null)}}catch(r){console.error("Image prediction error:",r),t(r?.message||"Failed to process image. Please try again.")}finally{c(!1)}},E=async()=>{if(!a){alert("Please predict the medicine classification first.");return}const r={genericName:n.generic_name,brandName:n.brand_name,dosageForm:n.dosage_form,packagingType:n.packaging_type,predictedCategory:a.predicted_category,riskLevel:a.risk_level,confidence:a.confidence,disposalGuidance:a.disposal_guidance,reason:"user_initiated"};try{if(c(!0),o){const s={...r,file:o},i=await S.create(s);if(i&&i.success)alert("Disposal saved successfully!"),p("/user/history");else{const d=i?.error?.message||i?.error||"Failed to save disposal.";t(d)}}else{const s=await S.create(r);if(s&&s.success)alert("Disposal saved successfully!"),p("/user/history");else{const i=s?.error?.message||s?.error||"Failed to save disposal.";t(i)}}}catch(s){console.error("Error saving disposal:",s),t(s?.message||"Failed to save disposal. Please try again.")}finally{c(!1)}},O=()=>{if(!a){alert("Please predict the medicine classification first.");return}p("/user/chw-interaction",{state:{medicineName:`${n.generic_name}${n.brand_name?` (${n.brand_name})`:""}`,disposalGuidance:a.disposal_guidance,riskLevel:a.risk_level}})},H=async r=>{try{const s=await u.search(r);s.success&&x(s.data)}catch(s){console.error("Search error:",s)}};return e.jsxs("div",{className:"p-4 lg:p-8 pb-24 lg:pb-8 max-w-5xl mx-auto",children:[e.jsx("div",{className:"mb-6",children:e.jsx(U,{onSearch:H,placeholder:"Search medicines for this form..."})}),e.jsx("h1",{className:"text-3xl font-bold text-text-dark dark:text-text-light mb-2",children:"Add New Disposal"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-8",children:"Enter medicine details to get proper disposal guidance"}),v&&e.jsx("div",{className:"mb-4 p-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded-lg",children:v}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Option 1: Upload Image"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center",children:[f?e.jsx("div",{className:"mb-4",children:e.jsx("img",{src:f,alt:"Medicine preview",className:"max-h-44 w-auto mx-auto rounded-lg object-contain"})}):e.jsx(M,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsxs("label",{className:"btn-outline cursor-pointer inline-block",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:G,className:"hidden"}),f?"Change Image":"Upload Image"]}),o&&e.jsx("button",{onClick:B,disabled:g,className:"btn-primary ml-4",children:g?e.jsx(N,{className:"w-5 h-5 animate-spin inline"}):"Scan Image"})]})]}),e.jsxs("form",{onSubmit:T,className:"card",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Option 2: Enter Details Manually"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(k,{label:"Generic Medicine Name",id:"generic_name",name:"generic_name",value:n.generic_name,onChange:h,placeholder:"e.g., Paracetamol",required:!0,autoComplete:"off"}),_.length>0&&e.jsx("div",{className:"absolute z-10 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg",children:_.map(r=>e.jsxs("button",{type:"button",onClick:()=>A(r),className:"w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:[e.jsx("div",{className:"font-medium",children:r.genericName}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[r.brandName," • ",r.dosageForm]})]},r.id))})]}),e.jsx("div",{children:e.jsx(k,{label:"Brand Name (Optional)",id:"brand_name",name:"brand_name",value:n.brand_name,onChange:h,placeholder:"e.g., Panadol"})}),e.jsx("div",{children:e.jsx(w,{label:"Dosage Form",id:"dosage_form",name:"dosage_form",value:n.dosage_form,onChange:h,options:D})}),e.jsx("div",{children:e.jsx(w,{label:"Packaging Type",id:"packaging_type",name:"packaging_type",value:n.packaging_type,onChange:h,options:R})})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"submit",disabled:g,className:"btn-primary w-full",children:g?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-5 h-5 animate-spin inline mr-2"}),"Analyzing..."]}):"Get Disposal Guidance"})})]})]}),a&&e.jsxs("div",{className:"card mt-6 border-2 border-primary-blue dark:border-accent-cta",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[a.risk_level==="HIGH"?e.jsx($,{className:"w-8 h-8 text-warning flex-shrink-0"}):e.jsx(q,{className:"w-8 h-8 text-primary-green flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Classification Results"}),e.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[e.jsx("span",{className:"badge badge-info",children:a.predicted_category}),e.jsxs("span",{className:`badge badge-${a.risk_level==="HIGH"?"danger":a.risk_level==="MEDIUM"?"warning":"success"}`,children:[a.risk_level," Risk"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Confidence Level"}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:e.jsx("div",{className:"bg-primary-green h-3 rounded-full transition-all duration-500",style:{width:`${a.confidence*100}%`}})}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:[(a.confidence*100).toFixed(0),"%"]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-4",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Disposal Guidance:"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.disposal_guidance})]}),a.ocr_info&&e.jsxs("div",{className:"mb-4",children:[e.jsx("button",{type:"button",onClick:()=>I(!y),className:"text-sm text-primary-blue dark:text-accent-cta font-medium mb-2",children:y?"Hide OCR details":"Show OCR details"}),y&&e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg p-4 border",children:[e.jsx("h4",{className:"font-bold mb-2",children:"OCR Extraction (image)"}),e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Confidence:"})," ",a.ocr_info.confidence??"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Medicine texts found:"})," ",a.ocr_info.medicine_texts_found??0]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Generic name:"})," ",a.ocr_info.extracted_info?.generic_name||"—"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Brand name:"})," ",a.ocr_info.extracted_info?.brand_name||"—"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Dosage / Strength:"})," ",a.ocr_info.extracted_info?.dosage_strength||"—"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Dosage form:"})," ",a.ocr_info.extracted_info?.dosage_form||"—"]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("strong",{children:"Active ingredients:"})," ",(a.ocr_info.extracted_info?.active_ingredients||[]).join(", ")||"—"]}),a.ocr_info.extracted_info?.other_info&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("strong",{children:"Other:"})," ",(a.ocr_info.extracted_info.other_info||[]).join(", ")]})]})]})]}),a.safety_guidance&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-2",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Recommended Action"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.safety_guidance.procedure||a.disposal_guidance||"Follow local disposal procedures."})]}),e.jsx("button",{type:"button",onClick:()=>F(!j),className:"text-sm text-primary-blue dark:text-accent-cta font-medium mb-2",children:j?"Hide advanced guidance":"Show advanced guidance"}),j&&e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900 rounded-lg p-4 border",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Advanced Safety Guidance"}),a.safety_guidance.prohibitions&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Prohibitions:"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.safety_guidance.prohibitions})]}),a.safety_guidance.risks&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Risks:"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.safety_guidance.risks})]}),a.safety_guidance.special_instructions&&e.jsxs("div",{children:[e.jsx("strong",{children:"Special instructions:"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.safety_guidance.special_instructions})]})]})]}),a.safety_notes&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 rounded-lg p-4 mb-4",children:[e.jsx("h4",{className:"font-bold mb-2",children:"Safety Notes:"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:a.safety_notes})]}),e.jsxs("div",{className:"flex gap-4 flex-nowrap",children:[e.jsx("button",{onClick:E,className:"btn-secondary flex-1 min-w-0",children:"Save Disposal"}),e.jsx("button",{onClick:O,className:`btn-primary flex-1 min-w-0 ${a?"":"opacity-50 cursor-not-allowed"}`,disabled:!a,title:a?"Request CHW pickup":"Analyze to enable pickup request",children:"Request CHW Pickup"})]})]})]})}export{Y as default};
