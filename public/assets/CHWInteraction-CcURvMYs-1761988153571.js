import{e as A,r as l,j as e,G as D,y as E,x as M,$ as F}from"./vendor_react-Dd6aiuOH-1761988153571.js";import{I as b}from"./Input-BWxF2S0i-1761988153571.js";import{T as _}from"./Textarea-CGSd5gIy-1761988153571.js";import{S as $}from"./Select-AVtcNLMy-1761988153571.js";import{T as O}from"./Table-BgUSxC-z-1761988153571.js";import{S as K}from"./SearchBar-CyxZkODN-1761988153571.js";import{c as B,p as C,d as J}from"./index-BNm4ZFjM-1761988153571.js";import"./vendor_misc-i1ZNofER-1761988153571.js";import"./vendor_axios-ngrFHoWO-1761988153571.js";function re(){const u=A().state||{},[p,w]=l.useState(""),[x,S]=l.useState([]),[f,P]=l.useState([]),[L,y]=l.useState(!0),[k,H]=l.useState(""),i=JSON.parse(localStorage.getItem("user")||"{}");l.useEffect(()=>{d();const a=setInterval(()=>{d()},1e4),r=()=>{document.hidden||d()};return document.addEventListener("visibilitychange",r),()=>{clearInterval(a),document.removeEventListener("visibilitychange",r)}},[]);const d=async()=>{try{y(!0);const[a,r]=await Promise.all([B.getAvailable(),C.getAll()]);a.success&&S(a.data),r.success&&P(r.data)}catch(a){console.error("Error fetching data:",a),H("Failed to load CHW data")}finally{y(!1)}},N=l.useMemo(()=>{let a=x;if(i.sector&&(a=x.filter(s=>s.sector&&s.sector.toLowerCase()===i.sector.toLowerCase())),!p)return a;const r=p.toLowerCase();return a.filter(s=>(s.name||"").toLowerCase().includes(r)||(s.sector||"").toLowerCase().includes(r)||(s.coverageArea||"").toLowerCase().includes(r)||(s.phone||"").toLowerCase().includes(r))},[p,x,i.sector]),[n,g]=l.useState(null),[t,h]=l.useState({medicineName:u.medicineName||"",disposalGuidance:u.disposalGuidance||"",reason:"",pickupLocation:"",preferredTime:"",consent:!1}),[W,j]=l.useState(!1),[U,v]=l.useState(!1),q=[{value:"expired",label:"Medicine Expired"},{value:"no_longer_needed",label:"No Longer Needed"},{value:"completed_treatment",label:"Completed Treatment"},{value:"adverse_reaction",label:"Adverse Reaction"},{value:"other",label:"Other"}],I=a=>{g(a)},c=a=>{const{name:r,value:s,type:o,checked:m}=a.target;h({...t,[r]:o==="checkbox"?m:s})},T=async a=>{if(a.preventDefault(),!n){alert("Please select a CHW first.");return}if(!t.consent){alert("Please provide consent to share your information.");return}const r={chwId:n.id,medicineName:t.medicineName,disposalGuidance:t.disposalGuidance,reason:t.reason,pickupLocation:t.pickupLocation,preferredTime:t.preferredTime,consentGiven:t.consent};try{v(!0);const s=await C.create(r);if(s.success){j(!0),setTimeout(()=>j(!1),5e3),h({medicineName:"",disposalGuidance:"",reason:"",pickupLocation:"",preferredTime:"",consent:!1}),g(null),d();try{const o=u.disposalId,m=s.data?.id||s.data?.data?.id||s?.data?.id||null;o&&m&&await J.update(o,{status:"pickup_requested",pickupRequestId:m})}catch(o){console.warn("Failed to attach pickup to disposal",o)}}}catch(s){console.error("Error submitting pickup request:",s),alert("Failed to submit pickup request. Please try again.")}finally{v(!1)}h({medicineName:"",disposalGuidance:"",reason:"",pickupLocation:"",preferredTime:"",consent:!1}),g(null)},G=l.useMemo(()=>f.map(a=>({...a,chwName:a.chw?.name||"Not assigned",createdAt:new Date(a.createdAt).toLocaleDateString()})),[f]),R=[{key:"medicineName",label:"Medicine",sortable:!0},{key:"chwName",label:"CHW",sortable:!0},{key:"status",label:"Status",sortable:!0,render:a=>e.jsx("span",{className:`badge badge-${a==="completed"?"success":a==="scheduled"?"info":a==="pending"?"warning":"danger"}`,children:a.toUpperCase()})},{key:"createdAt",label:"Requested",sortable:!0}];return L?e.jsx("div",{className:"p-4 lg:p-8 pb-24 lg:pb-8",children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading CHW data..."})]})})}):e.jsxs("div",{className:"p-4 lg:p-8 pb-24 lg:pb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-text-dark dark:text-text-light mb-2",children:"Request CHW Pickup"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-8",children:"Connect with Community Health Workers for safe medicine disposal"}),k&&e.jsx("div",{className:"mb-4 p-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded-lg",children:k}),W&&e.jsxs("div",{className:"mb-6 p-4 bg-green-100 dark:bg-green-900 dark:bg-opacity-30 border-l-4 border-green-500 rounded-lg flex items-center gap-3",children:[e.jsx(D,{className:"w-6 h-6 text-green-600 dark:text-green-400"}),e.jsx("p",{className:"text-green-800 dark:text-green-200 font-medium",children:"Pickup request submitted successfully! The CHW will contact you soon."})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Community Health Workers in Your Sector"}),i.sector&&e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:["Showing CHWs from ",e.jsx("span",{className:"font-semibold text-primary-blue dark:text-accent-cta",children:i.sector})," sector"]}),!i.sector&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-800 dark:text-yellow-300",children:"Please update your sector in your profile to see CHWs in your area."})}),e.jsx("div",{className:"mb-4 max-w-md",children:e.jsx(K,{onSearch:a=>w(a),placeholder:"Search CHWs by name, sector or coverage area..."})}),e.jsx("div",{className:"space-y-3",children:N.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:i.sector?`No CHWs available in ${i.sector} sector at the moment.`:"Please set your sector in your profile to see available CHWs."})}):N.map(a=>e.jsx("div",{className:`border-2 rounded-lg p-4 cursor-pointer transition-all ${n?.id===a.id?"border-primary-blue dark:border-accent-cta bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20":"border-gray-200 dark:border-gray-700 hover:border-primary-blue dark:hover:border-accent-cta"}`,onClick:()=>I(a),children:e.jsx("div",{className:"flex items-start justify-between gap-4",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-primary-green text-white flex items-center justify-center font-semibold flex-shrink-0",children:a.avatar}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:a.name}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1",children:[e.jsx(E,{className:"w-4 h-4"}),a.coverageArea]}),e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1",children:[e.jsx(M,{className:"w-4 h-4"}),a.phone]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("span",{className:`badge ${a.availability==="available"?"badge-success":"badge-warning"}`,children:a.availability}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1",children:[e.jsx(F,{className:"w-4 h-4 text-yellow-500 fill-yellow-500"}),a.rating]})]})]})]})})},a.id))})]}),e.jsxs("form",{onSubmit:T,className:"card",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Pickup Request Form"}),n?e.jsx("div",{className:"mb-4 p-3 bg-green-50 dark:bg-green-900 dark:bg-opacity-20 rounded-lg",children:e.jsxs("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:["Selected CHW: ",e.jsx("span",{className:"font-semibold",children:n.name})]})}):e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 rounded-lg",children:e.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Please select a CHW from the list"})}),e.jsx(b,{label:"Medicine Name",id:"medicineName",name:"medicineName",value:t.medicineName,onChange:c,placeholder:"e.g., Paracetamol (Panadol)",required:!0}),e.jsx(_,{label:"Disposal Guidance (Pre-filled)",id:"disposalGuidance",name:"disposalGuidance",value:t.disposalGuidance,onChange:c,rows:3,placeholder:"Disposal instructions will appear here after classification"}),e.jsx($,{label:"Reason for Disposal",id:"reason",name:"reason",value:t.reason,onChange:c,options:q,required:!0}),e.jsx(b,{label:"Pickup Location",id:"pickupLocation",name:"pickupLocation",value:t.pickupLocation,onChange:c,placeholder:"e.g., KG 123 St, Remera, Kigali",required:!0}),e.jsx(b,{label:"Preferred Pickup Time",id:"preferredTime",name:"preferredTime",type:"datetime-local",value:t.preferredTime,onChange:c,required:!0}),e.jsx("div",{className:"mb-6",children:e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",name:"consent",checked:t.consent,onChange:c,className:"mt-1 w-5 h-5 text-primary-blue focus:ring-accent-cta rounded",required:!0}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"I consent to share my contact information and location with the selected Community Health Worker for the purpose of medicine pickup and disposal."})]})}),e.jsx("button",{type:"submit",disabled:!n||!t.consent,className:"btn-primary w-full",children:"Submit Pickup Request"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"My Pickup Requests"}),e.jsx(O,{columns:R,data:G})]})]})}export{re as default};
